<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<title>CombineHarvester: Examples Part III</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CombineHarvester
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('intro3.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Examples Part III </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_docs_Example3"></a></p>
<p><b>File</b>: CombineTools/bin/Example3.cpp</p>
<p>This examples demonstrates how to create a simple four-bin counting experiment datacard. It is based on the example given on the combine twiki <a href="https://twiki.cern.ch/twiki/bin/viewauth/CMS/HiggsWG/SWGuideNonStandardCombineUses#Rate_Parameters">here</a>. Special <code>rateParam</code> directives are added to the datacard to allow the normalisations in three of these four bins to float freely and the fourth will be expressed as a function of the these three parameters. Here we follow the C++ interface example, a similar python version can be found in <code>CombineTools/scripts/Example3.py</code>. Make sure all the code is compiled and run the example: </p><pre class="fragment">cd $CMSSW_BASE/src
scram b -j4
Example3
</pre><p> We start by defining four categories: A, B, C and D in the normal way. Contrary to the previous shape-based examples, with a counting experiment we have to specify all of the observed and expected yields directly. To start with we'll define a map containing the observed yields in each category.</p>
<div class="fragment"><div class="line">  <span class="comment">// Define four categories labelled A, B, C and D, and</span></div>
<div class="line">  <span class="comment">// set the observed yields in a map.</span></div>
<div class="line">  <a class="code" href="namespacech.html#aa97b500b98aeaa86756eb1c5395a866e">ch::Categories</a> cats = {</div>
<div class="line">      {0, <span class="stringliteral">&quot;A&quot;</span>},</div>
<div class="line">      {1, <span class="stringliteral">&quot;B&quot;</span>},</div>
<div class="line">      {2, <span class="stringliteral">&quot;C&quot;</span>},</div>
<div class="line">      {3, <span class="stringliteral">&quot;D&quot;</span>}</div>
<div class="line">    };</div>
<div class="line">  std::map&lt;std::string, float&gt; obs_rates = {</div>
<div class="line">    {<span class="stringliteral">&quot;A&quot;</span>, 10.},</div>
<div class="line">    {<span class="stringliteral">&quot;B&quot;</span>, 50.},</div>
<div class="line">    {<span class="stringliteral">&quot;C&quot;</span>, 100.},</div>
<div class="line">    {<span class="stringliteral">&quot;D&quot;</span>, 500.}</div>
<div class="line">  };</div>
<div class="ttc" id="anamespacech_html_aa97b500b98aeaa86756eb1c5395a866e"><div class="ttname"><a href="namespacech.html#aa97b500b98aeaa86756eb1c5395a866e">ch::Categories</a></div><div class="ttdeci">std::vector&lt; std::pair&lt; int, std::string &gt; &gt; Categories</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester_8h_source.html#l00028">CombineHarvester.h:28</a></div></div>
</div><!-- fragment --><p> Next we create the CombineHarvester instance and populate it with Observation and Process entries. Then using the <code>ForEachProc</code> and <code>ForEachObs</code> methods we supply small lambda functions that set the observed and expected yields, for the former using our map defined above. For the latter we will set each yield to one and then create some <code>rateParam</code> entries that will allow these yields to float.</p>
<div class="fragment"><div class="line">  <a class="code" href="classch_1_1_combine_harvester.html">ch::CombineHarvester</a> cb;</div>
<div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#a00245515d95807d1d0c9501c5360ac01">SetVerbosity</a>(3);</div>
<div class="line"> </div>
<div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#a8d7ccde30bda35ec084f4e38b923ef23">AddObservations</a>({<span class="stringliteral">&quot;*&quot;</span>}, {<span class="stringliteral">&quot;&quot;</span>}, {<span class="stringliteral">&quot;13TeV&quot;</span>}, {<span class="stringliteral">&quot;&quot;</span>},          cats);</div>
<div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#a1ecb940a59ea7a2039956a07882e9ccc">AddProcesses</a>(   {<span class="stringliteral">&quot;*&quot;</span>}, {<span class="stringliteral">&quot;&quot;</span>}, {<span class="stringliteral">&quot;13TeV&quot;</span>}, {<span class="stringliteral">&quot;&quot;</span>}, {<span class="stringliteral">&quot;bkg&quot;</span>}, cats, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#a8f679f5e6e6cba2dd10f2d5eb14c4b20">ForEachObs</a>([&amp;](<a class="code" href="classch_1_1_observation.html">ch::Observation</a> *x) {</div>
<div class="line">    x-&gt;<a class="code" href="classch_1_1_observation.html#a08892e94877d2006921a9e3b3007eb3b">set_rate</a>(obs_rates[x-&gt;<a class="code" href="classch_1_1_object.html#a7b588d78c22464ebe2b793cbaa2366d3">bin</a>()]);</div>
<div class="line">  });</div>
<div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#a44064524ffe47ccac63ef8025a6f46dc">ForEachProc</a>([](<a class="code" href="classch_1_1_process.html">ch::Process</a> *x) {</div>
<div class="line">    x-&gt;<a class="code" href="classch_1_1_process.html#a178a4692175af3cb3f9699f424a03b30">set_rate</a>(1);</div>
<div class="line">  });</div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html"><div class="ttname"><a href="classch_1_1_combine_harvester.html">ch::CombineHarvester</a></div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester_8h_source.html#l00030">CombineHarvester.h:30</a></div></div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html_a00245515d95807d1d0c9501c5360ac01"><div class="ttname"><a href="classch_1_1_combine_harvester.html#a00245515d95807d1d0c9501c5360ac01">ch::CombineHarvester::SetVerbosity</a></div><div class="ttdeci">void SetVerbosity(unsigned verbosity)</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester_8h_source.html#l00095">CombineHarvester.h:95</a></div></div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html_a1ecb940a59ea7a2039956a07882e9ccc"><div class="ttname"><a href="classch_1_1_combine_harvester.html#a1ecb940a59ea7a2039956a07882e9ccc">ch::CombineHarvester::AddProcesses</a></div><div class="ttdeci">void AddProcesses(std::vector&lt; std::string &gt; mass, std::vector&lt; std::string &gt; analysis, std::vector&lt; std::string &gt; era, std::vector&lt; std::string &gt; channel, std::vector&lt; std::string &gt; procs, ch::Categories bin, bool signal)</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester___creation_8cc_source.html#l00045">CombineHarvester_Creation.cc:45</a></div></div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html_a44064524ffe47ccac63ef8025a6f46dc"><div class="ttname"><a href="classch_1_1_combine_harvester.html#a44064524ffe47ccac63ef8025a6f46dc">ch::CombineHarvester::ForEachProc</a></div><div class="ttdeci">void ForEachProc(Function func)</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester_8h_source.html#l00636">CombineHarvester.h:636</a></div></div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html_a8d7ccde30bda35ec084f4e38b923ef23"><div class="ttname"><a href="classch_1_1_combine_harvester.html#a8d7ccde30bda35ec084f4e38b923ef23">ch::CombineHarvester::AddObservations</a></div><div class="ttdeci">void AddObservations(std::vector&lt; std::string &gt; mass, std::vector&lt; std::string &gt; analysis, std::vector&lt; std::string &gt; era, std::vector&lt; std::string &gt; channel, ch::Categories bin)</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester___creation_8cc_source.html#l00020">CombineHarvester_Creation.cc:20</a></div></div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html_a8f679f5e6e6cba2dd10f2d5eb14c4b20"><div class="ttname"><a href="classch_1_1_combine_harvester.html#a8f679f5e6e6cba2dd10f2d5eb14c4b20">ch::CombineHarvester::ForEachObs</a></div><div class="ttdeci">void ForEachObs(Function func)</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester_8h_source.html#l00641">CombineHarvester.h:641</a></div></div>
<div class="ttc" id="aclassch_1_1_object_html_a7b588d78c22464ebe2b793cbaa2366d3"><div class="ttname"><a href="classch_1_1_object.html#a7b588d78c22464ebe2b793cbaa2366d3">ch::Object::bin</a></div><div class="ttdeci">virtual std::string const  &amp; bin() const</div><div class="ttdef"><b>Definition:</b> <a href="_object_8h_source.html#l00017">Object.h:17</a></div></div>
<div class="ttc" id="aclassch_1_1_observation_html"><div class="ttname"><a href="classch_1_1_observation.html">ch::Observation</a></div><div class="ttdef"><b>Definition:</b> <a href="_observation_8h_source.html#l00012">Observation.h:12</a></div></div>
<div class="ttc" id="aclassch_1_1_observation_html_a08892e94877d2006921a9e3b3007eb3b"><div class="ttname"><a href="classch_1_1_observation.html#a08892e94877d2006921a9e3b3007eb3b">ch::Observation::set_rate</a></div><div class="ttdeci">void set_rate(double const &amp;rate)</div><div class="ttdef"><b>Definition:</b> <a href="_observation_8h_source.html#l00020">Observation.h:20</a></div></div>
<div class="ttc" id="aclassch_1_1_process_html"><div class="ttname"><a href="classch_1_1_process.html">ch::Process</a></div><div class="ttdef"><b>Definition:</b> <a href="_process_8h_source.html#l00015">Process.h:15</a></div></div>
<div class="ttc" id="aclassch_1_1_process_html_a178a4692175af3cb3f9699f424a03b30"><div class="ttname"><a href="classch_1_1_process.html#a178a4692175af3cb3f9699f424a03b30">ch::Process::set_rate</a></div><div class="ttdeci">void set_rate(double const &amp;rate)</div><div class="ttdef"><b>Definition:</b> <a href="_process_8h_source.html#l00024">Process.h:24</a></div></div>
</div><!-- fragment --><p> First we add a regular <code>lnN</code> systematic uncertainty with the <code>AddSyst</code> method. Then, using the same technique, we add a <code>rateParam</code> systematic to each of the bins B, C and D. The name we give will be turned into a floating parameter which will be multiplied by the process yield that we set above to determine the overall process normalisation in the model. The name we specify here supports pattern substitution like any other systematic. In this case we have created a unique parameter per bin. In the SystMap we set the initial value of each parameter to the observed yield in the respective bin.</p>
<p>Then we create the second type of <code>rateParam</code> term, one which is a function of the other parameters we have specified. This sets the expected yield in bin A as a function of the three free parameters we just created, like in a standard ABCD method to set a background normalisation via control regions. As for the floating parameters this expression will be multiplied by the nominal process yield. To define the expression we use different mapping object, a <code>SystMapFunc</code>, which accepts two string arguments instead of a float. The first is a RooFit formula in terms of generic parameters, e.g. <code>@0</code>, and the second is a comma-separated list of the corresponding parameter names.</p>
<div class="fragment"><div class="line">  <span class="keyword">using</span> <a class="code" href="classch_1_1syst_1_1_syst_map.html">ch::syst::SystMap</a>;</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="classch_1_1syst_1_1_syst_map_func.html">ch::syst::SystMapFunc</a>;</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="structch_1_1syst_1_1bin.html">ch::syst::bin</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add a traditional lnN systematic</span></div>
<div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#ade0f7c161d078a189404a274b93336d2">cp</a>().<a class="code" href="classch_1_1_combine_harvester.html#a83dd50569a1f1a4b5a46f2ad2b5c1cdb">bin</a>({<span class="stringliteral">&quot;D&quot;</span>}).AddSyst(cb, <span class="stringliteral">&quot;DummySys&quot;</span>, <span class="stringliteral">&quot;lnN&quot;</span>, SystMap&lt;&gt;::init(1.0001));</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Create a unqiue floating parameter in each bin</span></div>
<div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#ade0f7c161d078a189404a274b93336d2">cp</a>().<a class="code" href="classch_1_1_combine_harvester.html#a83dd50569a1f1a4b5a46f2ad2b5c1cdb">bin</a>({<span class="stringliteral">&quot;B&quot;</span>, <span class="stringliteral">&quot;C&quot;</span>, <span class="stringliteral">&quot;D&quot;</span>}).AddSyst(cb, <span class="stringliteral">&quot;scale_$BIN&quot;</span>, <span class="stringliteral">&quot;rateParam&quot;</span>, SystMap&lt;bin&gt;::init</div>
<div class="line">          ({<span class="stringliteral">&quot;B&quot;</span>}, obs_rates[<span class="stringliteral">&quot;B&quot;</span>])</div>
<div class="line">          ({<span class="stringliteral">&quot;C&quot;</span>}, obs_rates[<span class="stringliteral">&quot;C&quot;</span>])</div>
<div class="line">          ({<span class="stringliteral">&quot;D&quot;</span>}, obs_rates[<span class="stringliteral">&quot;D&quot;</span>])</div>
<div class="line">      );</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create a function that sets the yield in A as a function of B, C and D</span></div>
<div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#ade0f7c161d078a189404a274b93336d2">cp</a>().<a class="code" href="classch_1_1_combine_harvester.html#a83dd50569a1f1a4b5a46f2ad2b5c1cdb">bin</a>({<span class="stringliteral">&quot;A&quot;</span>}).AddSyst(cb, <span class="stringliteral">&quot;scale_$BIN&quot;</span>, <span class="stringliteral">&quot;rateParam&quot;</span>, SystMapFunc&lt;&gt;::init</div>
<div class="line">          (<span class="stringliteral">&quot;(@0*@1/@2)&quot;</span>, <span class="stringliteral">&quot;scale_B,scale_C,scale_D&quot;</span>)</div>
<div class="line">      );</div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html_a83dd50569a1f1a4b5a46f2ad2b5c1cdb"><div class="ttname"><a href="classch_1_1_combine_harvester.html#a83dd50569a1f1a4b5a46f2ad2b5c1cdb">ch::CombineHarvester::bin</a></div><div class="ttdeci">CombineHarvester &amp; bin(std::vector&lt; std::string &gt; const &amp;vec, bool cond=true)</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester___filters_8cc_source.html#l00013">CombineHarvester_Filters.cc:13</a></div></div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html_ade0f7c161d078a189404a274b93336d2"><div class="ttname"><a href="classch_1_1_combine_harvester.html#ade0f7c161d078a189404a274b93336d2">ch::CombineHarvester::cp</a></div><div class="ttdeci">CombineHarvester cp()</div><div class="ttdoc">Creates and returns a shallow copy of the CombineHarvester instance.</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester_8cc_source.html#l00220">CombineHarvester.cc:220</a></div></div>
<div class="ttc" id="aclassch_1_1syst_1_1_syst_map_func_html"><div class="ttname"><a href="classch_1_1syst_1_1_syst_map_func.html">ch::syst::SystMapFunc</a></div><div class="ttdef"><b>Definition:</b> <a href="_systematics_8h_source.html#l00203">Systematics.h:203</a></div></div>
<div class="ttc" id="aclassch_1_1syst_1_1_syst_map_html"><div class="ttname"><a href="classch_1_1syst_1_1_syst_map.html">ch::syst::SystMap</a></div><div class="ttdef"><b>Definition:</b> <a href="_systematics_8h_source.html#l00070">Systematics.h:70</a></div></div>
<div class="ttc" id="astructch_1_1syst_1_1bin_html"><div class="ttname"><a href="structch_1_1syst_1_1bin.html">ch::syst::bin</a></div><div class="ttdef"><b>Definition:</b> <a href="_systematics_8h_source.html#l00011">Systematics.h:11</a></div></div>
</div><!-- fragment --> <dl class="section warning"><dt>Warning</dt><dd>When calling <code>AddSyst</code> a check is made to see if the named parameter already exists. If so, and if it is a floating parameter, its initial value will be updated. If it is a formula, then the existing formula will be used to create the Systematic and the new value will be ignored, i.e. once a formula has been entered into the CombineHarvester instance it cannot be modified.</dd></dl>
<p>Finally we print the CombineHarvester contents. Note that the while the Systematic entries for the <code>rateParam</code> terms are shown in the list the "value" column currently always shows zero. For floating terms the actual values are given in the final list of parameters. We end by writing the text datacard, where the initial parameter values and formulae will be written at the end.</p>
<div class="fragment"><div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#a63ffe9b598a7a6dc9f3cab118b3703df">PrintAll</a>();</div>
<div class="line">  cb.<a class="code" href="classch_1_1_combine_harvester.html#a63255dd5ec491fa12857bc63b4174e92">WriteDatacard</a>(<span class="stringliteral">&quot;example3.txt&quot;</span>);</div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html_a63255dd5ec491fa12857bc63b4174e92"><div class="ttname"><a href="classch_1_1_combine_harvester.html#a63255dd5ec491fa12857bc63b4174e92">ch::CombineHarvester::WriteDatacard</a></div><div class="ttdeci">void WriteDatacard(std::string const &amp;name, std::string const &amp;root_file)</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester___datacards_8cc_source.html#l00589">CombineHarvester_Datacards.cc:589</a></div></div>
<div class="ttc" id="aclassch_1_1_combine_harvester_html_a63ffe9b598a7a6dc9f3cab118b3703df"><div class="ttname"><a href="classch_1_1_combine_harvester.html#a63ffe9b598a7a6dc9f3cab118b3703df">ch::CombineHarvester::PrintAll</a></div><div class="ttdeci">CombineHarvester &amp; PrintAll()</div><div class="ttdef"><b>Definition:</b> <a href="_combine_harvester_8cc_source.html#l00226">CombineHarvester.cc:226</a></div></div>
</div><!-- fragment --> <dl class="section warning"><dt>Warning</dt><dd>None of the CombineHarvester methods that evaluate process rates or shapes currently evaluate the effect of the <code>rateParam</code> terms. This will be implemented in a later release. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
</body>
</html>
